srcdir = @srcdir@
prefix = @prefix@
datarootdir = @datarootdir@
exec_prefix = @exec_prefix@
includedir = @includedir@
mandir = @mandir@
sbindir = @sbindir@
bindir = @bindir@
libdir = @libdir@

VPATH = $(srcdir)
SHELL = @SHELL@

CC = @CC@
LD = @CC@
# make sure the srcdir include gets included first
CFLAGS += -Wall -Wextra -pedantic -std=gnu99 -ggdb  -Iinclude -I$(srcdir)/src @CFLAGS@ @CPPFLAGS@
LDFLAGS += @LDFLAGS@

#CFLAGS  += -Wall -Wextra -pedantic -std=gnu99 -ggdb  -I$(MPINC) -I../HDTraceWritingCLibrary/include  -Iinclude/ $(shell pkg-config --cflags glib-2.0)  `getconf LFS_CFLAGS` -D HDTRACE_INCLUDE_NESTED_TEST
#LDFLAGS += $(shell pkg-config --libs glib-2.0)

.PHONY: all
all: lib/libhdTraceMPIWrapper.a

lib/libhdTraceMPIWrapper.a: src/hdTraceMPIWrapper.o
	@echo "[ar] libhdTraceMPIWrapper.a"
	@ar rcs lib/libhdTraceMPIWrapper.a src/hdTraceMPIWrapper.o 

src/hdTraceMPIWrapper.o: src/hdTraceMPIWrapper.c
	@echo "[CC] src/hdTraceMPIWrapper.o"
	@$(CC) -c $(CFLAGS) src/hdTraceMPIWrapper.c -o src/hdTraceMPIWrapper.o

src/hdTraceMPIWrapper.c: src/hdTraceMPIWrapper.src.c scripts/create_sim-wrapper.py scripts/wrapper_conf.py include/interesting_funcs.h include/hdMPITracer.h.in src/hdMPITracer.c
	@echo "[PY] create"
	@cat $(srcdir)/src/hdTraceMPIWrapper.src.c > src/hdTraceMPIWrapper.c || exit 1
	@cat $(srcdir)/include/hdMPITracer.h.in > include/hdMPITracer.h || exit 1
	@$(srcdir)/scripts/create_sim-wrapper.py $(srcdir)/include/interesting_funcs.h src/hdTraceMPIWrapper.c include/hdMPITracer.h include/hdMPITracerCodeLocator.h

.PHONY: test

test:
	cd test ; make

.PHONY: hdtest

hdtest: all
	cd test ; make hdtest

.PHONY: clean

clean:
	cd test ; make clean
	rm -f src/*.o lib/*.a
	rm -f src/hdTraceMPIWrapper.c
	rm -rf doc/doxygen/html
	rm -rf doc/doxygen/latex
	cd doc ; rm -rf mpiwrapper.aux mpiwrapper.bbl mpiwrapper.blg mpiwrapper.log mpiwrapper.pdf mpiwrapper.toc 
	rm scripts/*.pyc

.PHONY: doc

doc:
	@echo "[doxygen]"
	@doxygen $(srcdir)/Doxyfile
	@echo "[latex]"
	@cd doc; latex $(srcdir)/doc/mpiwrapper.tex

dist-clean: clean
	rm -rf doc/doxygen/ config.status config.log lib/* include/hdMPITracerCodeLocator.h  include/hdMPITracer.h Makefile
		
install:
	install -d $(includedir)
	install -d $(libdir)
	install include/hdMPITracerCodeLocator.h $(includedir)
	install include/hdMPITracer.h $(includedir)
	install lib/libhdTraceMPIWrapper.a $(libdir)
